<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OptiGain Trend Forecaster</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .forecaster-container {
      max-width: 700px;
      margin: 60px auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      text-align: center;
    }
    .forecaster-container h2 {
      color: #0275d8;
      margin-bottom: 20px;
    }
    .upload-input {
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      width: 90%;
    }
    .btn {
      width: 95%;
      margin-top: 15px;
    }
    .chart-container {
      margin-top: 30px;
      background: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .forecast-img {
      margin-top: 20px;
      border-radius: 10px;
      max-width: 100%;
      height: auto;
    }
    body.dark-mode .forecaster-container {
      background: #1e1e1e;
      color: #fff;
    }
    body.dark-mode .chart-container {
      background: #222;
    }
  </style>
</head>

<body>

<!-- Navbar -->
<nav style="background-color:#0275d8; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; color:white;">
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="OptiGain Logo" style="height:40px;">
    <h2 style="margin:0;">OptiGain</h2>
  </div>
  <div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-light">â¬… Dashboard</a>
  </div>
</nav>

<!-- Main Content -->
<div class="forecaster-container">
  <h2>ðŸ“ˆ Trend Forecaster</h2>
  <p>Upload your revenue CSV or connect to your live business data feed to visualize trends and forecast growth.</p>

  <form method="POST" enctype="multipart/form-data">
    <input type="file" name="file" accept=".csv" class="upload-input" required>
    <button type="submit" class="btn btn-primary">Generate Forecast</button>
  </form>

  {% if forecast_plot %}
    <div class="chart-container">
      <h3>âœ… Forecast Generated</h3>
      <img src="{{ url_for('static', filename='forecast.png') }}" class="forecast-img" alt="Forecast Graph">
    </div>
  {% endif %}

  <!-- Future Live Forecast Section -->
  <div class="chart-container" id="liveForecastContainer" style="display:none;">
    <h3>ðŸ“Š Live Forecast Updates</h3>
    <div id="liveForecastChart" style="height:400px;"></div>
  </div>
<!-- âœ… Add Back to Dashboard button here -->
  <div style="margin-top:30px;">
    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">â¬… Back to Dashboard</a>
  </div>
</div>
</div>

<button id="darkToggle" class="dark-toggle">ðŸŒ™ Dark Mode</button>

<script>
  // ðŸŒ™ Dark Mode toggle (consistent with dashboard)
  const darkToggle = document.getElementById('darkToggle');
  if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
  darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });

  // ðŸš€ Future: Fetch live trend data (after M-Pesa shortcode integration)
  // This will auto-update the forecast chart every few seconds
  async function loadLiveForecast() {
    try {
      const res = await fetch('/api/live_forecast');
      const data = await res.json();

      if (!data || !data.dates) return;

      document.getElementById('liveForecastContainer').style.display = 'block';

      const trace = {
        x: data.dates,
        y: data.values,
        mode: 'lines+markers',
        name: 'Live Forecast',
        line: { color: '#00c6ff', width: 3 }
      };

      const layout = {
        title: 'Real-time Revenue Trend',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Revenue (KSh)' },
        plot_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#f9f9f9',
        paper_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        font: { color: document.body.classList.contains('dark-mode') ? '#fff' : '#000' }
      };

      Plotly.newPlot('liveForecastChart', [trace], layout);
    } catch (err) {
      console.error('Live forecast load failed:', err);
    }
  }

  // Refresh every 20 seconds once live
  // (This will automatically work once you have your shortcode + API live)
  // setInterval(loadLiveForecast, 20000);
</script>

</body>
</html>