<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="60">
    <title>Dashboard - Profit Optimizer</title>

    <!-- ‚úÖ Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- ‚úÖ Your custom CSS (must come after Bootstrap so it overrides styles) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- ‚úÖ Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>


{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <div class="top-bar">
        <h1>Welcome, {{ session['user'] }}</h1>
<!-- üåô Dark Mode Toggle -->
<button id="darkToggle" class="dark-toggle">üåô Dark Mode</button>
    </div>

<!-- üí∞ Live Balance Section -->
<div class="container my-3">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card text-center shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">üí∞ Live M-Pesa Business Balance</h5>
          <h3 id="balance-amount" class="fw-bold text-success">Loading...</h3>
          <p id="balance-updated" class="text-muted small mt-2">last updated: just now</p>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container my-4">
  <div class="row g-3 text-center">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Total Profit</h5>
        <h3>{{ kpis.total_profit }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Average Profit</h5>
        <h3>{{ kpis.avg_profit }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Profit Growth</h5>
        <h3>{{ kpis.profit_growth }}</h3>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <h5 class="card-title">Largest Expense</h5>
        <h3>{{ kpis.largest_expense }}</h3>
      </div>
    </div>
  </div>
</div>
<div class="card">
  <h2>üìà Revenue Forecast (Next 6 Months)</h2>
  <ul>
    {% for item in forecast_data %}
      <li>{{ item.date }} ‚Üí {{ item.predicted_revenue }}</li>
    {% endfor %}
  </ul>
</div>

<div class="card mt-4 p-3 shadow rounded-3">
  <h4 class="mb-3 text-center">üìà Live Financial Performance</h4>
  <div id="liveChart" style="height: 400px;"></div>
</div>

<div class="card mt-4 p-3 shadow rounded-3">
  <h4 class="mb-3 text-center">üìà Live Financial Performance</h4>
  <div id="liveChart" style="height: 400px;"></div>
</div>

<!-- üß† Smart AI Insights Section -->
{% if notifications %}
    <div class="notification" style="background:#fff; padding:15px; border-radius:10px; margin:5px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <strong>üß† Smart Notifications:</strong>
        <ul style="margin-top:10px;">
            {% for note in notifications %}
                <li>{{ note }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

{% if notifications %}
    <div class="notification">
        <strong>Smart Notifications:</strong>
        <ul>
            {% for note in notifications %}
                <li>{{ note }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div id="mpesaBalance" style="background:#fff;padding:10px;margin:10px 0;border-radius:8px;">
  <h3>üì± M-Pesa Business Balance</h3>
  <p id="balanceValue">Fetching balance...</p>
</div>

<script>
fetch("/api/mpesa_balance")
  .then(r => r.json())
  .then(data => {
      const balanceEl = document.getElementById("balance-amount");
      const timeEl = document.getElementById("balance-updated");

      if (data.Result) {
          balanceEl.innerText =
              data.Result.ResultParameters.ResultParameter[0].Value + " KSh" || "Unavailable";
      } else if (data.balance) {
          balanceEl.innerText = `${data.balance.toLocaleString()} KSh`;
      } else {
          balanceEl.innerText = "Unavailable";
      }

      // üïí Update timestamp
      if (timeEl) {
          timeEl.textContent = "Last updated: " + new Date().toLocaleTimeString();
      }
  })
  .catch(err => {
      document.getElementById("balance-amount").innerText = "Error loading balance";
  });
</script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
async function loadChart() {
  const res = await fetch('/api/financial_data');
  const data = await res.json();

  const months = data.month || [];
  const revenue = data.revenue || [];
  const expenses = data.expenses || [];
  const profit = data.profit || [];

  const trace1 = { x: months, y: revenue, type: 'scatter', name: 'Revenue' };
  const trace2 = { x: months, y: expenses, type: 'scatter', name: 'Expenses' };
  const trace3 = { x: months, y: profit, type: 'scatter', name: 'Profit' };

  const layout = {
    title: 'Company Financial Trends',
    xaxis: { title: 'Month' },
    yaxis: { title: 'Amount (KSh)' },
    plot_bgcolor: '#f9f9f9',
    paper_bgcolor: '#fff',
    margin: { t: 40, l: 50, r: 30, b: 50 }
  };

  Plotly.newPlot('liveChart', [trace1, trace2, trace3], layout);
}

// Refresh every 10 seconds
loadChart();
setInterval(loadChart, 10000);
</script>

<h3>üìä Revenue Forecast Trend</h3>
<div id="forecastPlotly" style="width: 100%; height: 500px;"></div>

<!-- Dropdown Filter -->
<div style="margin:10px 0;">
  <label for="metricSelect">Select Metric:</label>
  <select id="metricSelect">
      <option value="predicted_revenue">Revenue</option>
      <option value="profit">Profit</option>
      <option value="expenses">Expenses</option>
  </select>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const forecastData = JSON.parse('{{ forecast_chart | safe }}') || [];

    // Extract arrays for plotting
    const labels = forecastData.map(item => item.date);
    const revenue = forecastData.map(item => parseFloat(item.predicted_revenue || 0));
    const profit = forecastData.map(item => parseFloat(item.profit || 0));
    const expenses = forecastData.map(item => parseFloat(item.expenses || 0));

    const metricMap = { 'predicted_revenue': revenue, 'profit': profit, 'expenses': expenses };

    const plotData = [{
        x: labels,
        y: revenue,
        type: 'bar',
        name: 'Revenue',
        marker: { color: 'rgba(0, 123, 255, 0.7)' }
    }];

    const layout = {
        title: 'Financial Forecast',
        plot_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        paper_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        font: { color: document.body.classList.contains('dark-mode') ? '#fff' : '#000' }
    };

    Plotly.newPlot('forecastPlotly', plotData, layout);

// üß† Add AI Insight Overlays
const notificationsList = {{ notifications | tojson | safe }};
const annotations = [];

if (notificationsList && notificationsList.length > 0) {
    notificationsList.forEach((note, idx) => {
        // Position the annotation evenly along the chart
        const xIndex = idx % labels.length;
        annotations.push({
            x: labels[xIndex],
            y: revenue[xIndex] || 0,
            text: note.length > 60 ? note.slice(0, 60) + "‚Ä¶" : note,
            showarrow: true,
            arrowhead: 5,
            ax: 0,
            ay: -40,
            bgcolor: 'rgba(255,255,0,0.2)',
            bordercolor: '#ffcc00',
            font: { color: '#222', size: 12 }
        });
    });

    Plotly.relayout('forecastPlotly', { annotations });
}

    // Dropdown Filter
    document.getElementById('metricSelect').addEventListener('change', (e) => {
        const selected = e.target.value;
        const newY = metricMap[selected] || revenue;
        Plotly.update('forecastPlotly', { y: [newY], name: selected }, { title: `Financial Forecast - ${selected.replace('_', ' ').toUpperCase()}` });
    });

    // Dark Mode toggle sync
    const toggleBtn = document.getElementById('darkToggle');
    toggleBtn?.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-mode');
        Plotly.update('forecastPlotly', {}, {
            plot_bgcolor: isDark ? '#222' : '#fff',
            paper_bgcolor: isDark ? '#222' : '#fff',
            font: { color: isDark ? '#fff' : '#000' }
        });
    });
// Update annotations in dark mode
const updateAnnotationColors = (isDark) => {
    const annos = annotations.map(a => ({
        ...a,
        bgcolor: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,0,0.2)',
        font: { color: isDark ? '#fff' : '#222', size: 12 }
    }));
    Plotly.relayout('forecastPlotly', { annotations: annos });
};

toggleBtn?.addEventListener('click', () => {
    const isDark = document.body.classList.contains('dark-mode');
    updateAnnotationColors(isDark);
});
});
</script>
    {% if notifications %}
        <div class="notification">
            <strong>Smart Notifications:</strong>
            <ul>
                {% for note in notifications %}
                    <li>{{ note }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <!-- ‚úÖ Uploaded Files -->
    <div class="file-list">
        <h2>Your Uploaded Files:</h2>
        {% if files %}
            <ul>
                {% for file in files %}
                    <li><a href="{{ url_for('view_file', filename=file) }}">{{ file }}</a></li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No files uploaded yet.</p>
        {% endif %}
    </div>

<!-- üìä Revenue vs Expenses Graph -->
<div class="card">
    <h3 style="text-align:center;">Financial Performance</h3>
    <div>{{ graph_html|safe }}</div>
</div>

 <!-- ‚úÖ Feature Buttons (Bootstrap Responsive Layout) -->
<div class="container my-4">
  <div class="row g-2">
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('upload') }}" class="btn btn-primary w-100">Upload New CSV</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('manual_entry') }}" class="btn btn-success w-100">Manual Entry</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('use_demo_data') }}" class="btn btn-info w-100">Use Demo Data</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('profile') }}" class="btn btn-secondary w-100">My Profile</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('ask') }}" class="btn btn-info w-100">Business Assistant</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('admin') }}" class="btn btn-warning w-100">Admin Panel</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('profit_calculator') }}" class="btn btn-success w-100">Profit Calculator</a>
    </div>
    <div class="col-md-3 col-sm-6">
      <a href="{{ url_for('trend_forecaster') }}" class="btn btn-warning w-100">Trend Forecaster</a>
    </div>

    <!-- üìÑ Download Report Button -->
    <div class="col-md-3 col-sm-6">
      <form action="{{ url_for('download_report') }}" method="POST" class="d-grid">
        <input type="hidden" name="revenue" value="{{ kpis.total_revenue }}">
        <input type="hidden" name="expenses" value="{{ kpis.total_expenses }}">
        <input type="hidden" name="profit" value="{{ kpis.total_profit }}">
        <input type="hidden" name="margin" value="{{ kpis.profit_margin }}">
        <input type="hidden" name="advice" value="{{ advice }}">
        <button type="submit" class="btn btn-secondary w-100">üìÑ Download Report</button>
      </form>
    </div>
  </div>
</div>

<form action="{{ url_for('send_report') }}" method="POST" style="margin-top: 15px;">

  <!-- Hidden financial data -->
  <input type="hidden" name="revenue" value="{{ kpis.total_revenue }}">
  <input type="hidden" name="expenses" value="{{ kpis.total_expenses }}">
  <input type="hidden" name="profit" value="{{ kpis.total_profit }}">
  <input type="hidden" name="margin" value="{{ kpis.profit_margin }}">
  <input type="hidden" name="advice" value="{{ advice }}">

  <input type="email" name="email" placeholder="Enter recipient email" required 
         style="padding:8px; border-radius:5px; border:1px solid #ccc;">

  <button type="submit" class="btn btn-info">üìß Send Report</button>
</form>    



<nav class="navbar navbar-expand-lg navbar-dark bg-primary px-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="OptiGain Logo" height="40">
      <href="{{ url_for ('dashboard') }}" class="navbar-brand mb-0 hi text-white text-decoration-none">OptiGain<a>
    </div>
    <form action="{{ url_for('logout') }}" method="get" class="m-0">
      <button type="submit" class="btn btn-light btn-sm">Logout</button>
    </form>
  </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('darkToggle');
  const savedTheme = localStorage.getItem('theme');

  // Apply saved mode on load
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }

  // Toggle and save mode
  toggleBtn?.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // üí∞ Fetch and update M-Pesa balance
  async function fetchMpesaBalance() {
    try {
      const res = await fetch("/api/mpesa_balance");
      const data = await res.json();
      const balanceElement = document.getElementById("balance-amount");
      if (data.balance) {
        balanceElement.textContent = `${data.balance.toLocaleString()} KSh`;
      } else {
        balanceElement.textContent = "Unavailable";
      }
    } catch (err) {
      console.error("‚ö†Ô∏è Failed to fetch M-Pesa balance:", err);
      document.getElementById("balance-amount").textContent = "Unavailable";
    }
  }

  // üìä Fetch and update live transaction summary (real DB)
  async function loadTransactionSummary() {
    try {
      const res = await fetch("/api/transactions_summary");
      const data = await res.json();

      if (data.error) {
        console.warn("‚ö†Ô∏è Error loading summary:", data.error);
        return;
      }

      document.querySelectorAll(".card").forEach(card => {
        const title = card.querySelector("h5, h3")?.innerText?.trim();
        const valueEl = card.querySelector("h3, p");

        if (title === "Total Profit") {
          valueEl.innerText = `${data.total_profit?.toLocaleString() || "0"} KSh`;
        }
        if (title === "Average Profit") {
          valueEl.innerText = `${data.average_profit?.toLocaleString() || "0"} KSh`;
        }
        if (title === "Profit Growth") {
          valueEl.innerText = `${data.profit_growth?.toFixed(1) || 0}%`;
        }
        if (title === "Largest Expense") {
          valueEl.innerText = `${data.largest_expense?.toLocaleString() || "0"} KSh`;
        }
      });
    } catch (err) {
      console.error("‚ö†Ô∏è Failed to load transaction summary:", err);
    }
  }

  // ‚è± Refresh both every 20 seconds
  loadTransactionSummary();
  fetchMpesaBalance();
  setInterval(loadTransactionSummary, 20000);
  setInterval(fetchMpesaBalance, 20000);
});
</script>


<script>
async function loadInsights() {
  try {
    const res = await fetch('/api/ai_insights');
    const data = await res.json();

    const container = document.querySelector('.notification ul');
    if (container && Array.isArray(data)) {
      container.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        container.appendChild(li);
      });
    }
  } catch (err) {
    console.error("AI Insights refresh failed:", err);
  }
}

// Refresh AI insights every 20 seconds
loadInsights();
setInterval(loadInsights, 20000);
</script>

<!-- üìä Live Performance Graph (Revenue vs Expenses) -->
<div class="card" style="margin-top: 40px;">
    <h3>üìä Live Performance (Revenue vs Expenses)</h3>
    <div id="performanceChart"></div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
async function loadPerformanceChart() {
  try {
    const res = await fetch('/api/financial_data'); // or your Google Sheets route if different
    const data = await res.json();

    // üß© Ensure your backend returns the correct keys: month, revenue, expenses
    const months = data.month || [];
    const revenue = data.revenue || [];
    const expenses = data.expenses || [];

    if (months.length === 0) {
      document.getElementById('performanceChart').innerHTML =
        "<p style='text-align:center; color:gray;'>No data available yet.</p>";
      return;
    }

    const trace1 = {
      x: months,
      y: revenue,
      type: 'scatter',
      name: 'Revenue',
      line: { color: 'green', width: 3 }
    };

    const trace2 = {
      x: months,
      y: expenses,
      type: 'scatter',
      name: 'Expenses',
      line: { color: 'red', width: 3 }
    };

    const layout = {
      title: 'üìä Live Performance (Revenue vs Expenses)',
      xaxis: { title: 'Month' },
      yaxis: { title: 'Amount (KSh)' },
      margin: { t: 40, l: 60, r: 30, b: 40 },
      plot_bgcolor: '#f9f9f9',
      paper_bgcolor: '#fff'
    };

    Plotly.react('performanceChart', [trace1, trace2], layout);
  } catch (err) {
    console.error("‚ö†Ô∏è Failed to load performance chart:", err);
  }
}

// Initial load + refresh every 5 min (same as Google Sheets sync)
loadPerformanceChart();
setInterval(loadPerformanceChart, 5 * 60 * 1000);
</script>

<script>
async function loadTransactionSummary() {
  try {
    const res = await fetch('/api/transactions_summary');
    const data = await res.json();

    if (data.error) {
      console.warn("‚ö†Ô∏è Error loading summary:", data.error);
      return;
    }

    // Dynamically update KPI cards
    document.querySelectorAll('.kpi-card').forEach(card => {
      const title = card.querySelector('h3').innerText.trim();
      const valueEl = card.querySelector('p');

      if (title === 'Total Profit') {
        valueEl.innerText = `${data.total_profit?.toLocaleString() || '0'} KSh`;
      }
      if (title === 'Average Profit') {
        valueEl.innerText = `${data.average_profit?.toLocaleString() || '0'} KSh`;
      }
      if (title === 'Profit Growth') {
        valueEl.innerText = `${data.profit_growth?.toFixed(1) || 0}%`;
      }
      if (title === 'Largest Expense') {
        valueEl.innerText = `${data.largest_expense?.toLocaleString() || '0'} KSh`;
      }
    });

  } catch (err) {
    console.error("‚ö†Ô∏è Failed to load transaction summary:", err);
  }
}

// Load once and refresh every 30 seconds
loadTransactionSummary();
setInterval(loadTransactionSummary, 30000);
</script>

<footer class="text-center py-3 mt-5 text-muted border-top">
  ¬© {{ current_year }} OptiGain. All rights reserved.
</footer>
</body>
</html>