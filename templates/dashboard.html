<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="60">
    <title>Dashboard - Profit Optimizer</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS (after Bootstrap) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Plotly (once) -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="dashboard-body">

<!-- ðŸŒŸ SIDEBAR -->
<div class="sidebar">
    <div class="sidebar-header">
        <img src="{{ url_for('static', filename='logo.png') }}" class="sidebar-logo" alt="OptiGain Logo">
        <h2 class="sidebar-title">OptiGain</h2>
    </div>

    <ul class="sidebar-menu">
        <li><a href="{{ url_for('dashboard') }}">ðŸ“Š Dashboard</a></li>
        <li><a href="{{ url_for('upload') }}">ðŸ“¤ Upload CSV</a></li>
        <li><a href="{{ url_for('manual_entry') }}">âž• Manual Entry</a></li>
        <li><a href="{{ url_for('trend_forecaster') }}">ðŸ“ˆ Trend Forecaster</a></li>
        <li><a href="{{ url_for('profit_calculator') }}">ðŸ’µ Profit Calculator</a></li>
        <li><a href="{{ url_for('ask') }}">ðŸ¤– Business Assistant</a></li>
        <li><a href="{{ url_for('admin') }}">ðŸ›  Admin Panel</a></li>
        <li><a href="{{ url_for('profile') }}">ðŸ‘¤ My Profile</a></li>
        <li><a href="{{ url_for('logout') }}">ðŸšª Logout</a></li>
    </ul>
</div>

<!-- ðŸŒŸ MAIN CONTENT -->
<div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
        <h1 class="mb-0">Welcome, {{ session['user'] }}</h1>
        <button id="darkToggle" class="dark-toggle">ðŸŒ™</button>
    </div>

    <div class="container-fluid mt-3">

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- ðŸ’° Live M-Pesa Balance -->
        <div class="row justify-content-center mb-3">
          <div class="col-lg-6 col-md-8">
            <div class="card text-center shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title mb-2">ðŸ’° Live M-Pesa Business Balance</h5>
                <h3 id="balance-amount" class="fw-bold text-success">Loading...</h3>
                <p id="balance-updated" class="text-muted small mt-2">Last updated: just now</p>
              </div>
            </div>
          </div>
        </div>

        <!-- KPI CARDS -->
        <div id="kpi-row" class="row g-3 text-center mb-3">
          <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm p-3 kpi-card" data-kpi="total_profit">
              <h5 class="card-title mb-1">Total Profit</h5>
              <p class="card-value h4 mb-0">{{ kpis.total_profit }} KSh</p>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm p-3 kpi-card" data-kpi="avg_profit">
              <h5 class="card-title mb-1">Average Profit</h5>
              <p class="card-value h4 mb-0">{{ kpis.avg_profit }} KSh</p>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm p-3 kpi-card" data-kpi="profit_growth">
              <h5 class="card-title mb-1">Profit Growth</h5>
              <p class="card-value h4 mb-0">{{ kpis.profit_growth }}</p>
            </div>
          </div>
          <div class="col-md-3 col-sm-6">
            <div class="card shadow-sm p-3 kpi-card" data-kpi="largest_expense">
              <h5 class="card-title mb-1">Largest Expense</h5>
              <p class="card-value h4 mb-0">{{ kpis.largest_expense }}</p>
            </div>
          </div>
        </div>

        <!-- REVENUE FORECAST (TEXT LIST) -->
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h4 class="card-title mb-3">ðŸ“ˆ Revenue Forecast (Next 6 Months)</h4>
            <ul class="mb-0">
              {% for item in forecast_data %}
                <li>{{ item.date }} â†’ {{ item.predicted_revenue }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- LIVE FINANCIAL PERFORMANCE (LINE CHART) -->
        <div class="card mt-3 p-3 shadow rounded-3">
          <h4 class="mb-3 text-center">ðŸ“‰ Live Financial Performance</h4>
          <div id="liveChart" style="height: 400px;"></div>
        </div>

        <!-- FORECAST CHART + METRIC DROPDOWN -->
        <div class="card mt-4 p-3 shadow rounded-3">
          <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <h4 class="mb-0">ðŸ“Š Forecast Explorer</h4>
            <div>
              <label for="metricSelect" class="me-2">Metric:</label>
              <select id="metricSelect" class="form-select d-inline-block w-auto">
                <option value="predicted_revenue">Revenue</option>
                <option value="profit">Profit</option>
                <option value="expenses">Expenses</option>
              </select>
            </div>
          </div>
          <div id="forecastPlotly" style="width: 100%; height: 420px;"></div>
        </div>

        <!-- SMART AI NOTIFICATIONS -->
        {% if notifications %}
          <div class="card mt-4 p-3 shadow notification">
            <h4 class="mb-2">ðŸ§  Smart Insights</h4>
            <ul class="mb-0">
              {% for note in notifications %}
                <li>{{ note }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <!-- UPLOADED FILES -->
        <div class="card mt-4 p-3 shadow-sm">
          <h4>Your Uploaded Files</h4>
          {% if files %}
            <ul class="mb-0">
              {% for file in files %}
                <li><a href="{{ url_for('view_file', filename=file) }}">{{ file }}</a></li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="mb-0 text-muted">No files uploaded yet.</p>
          {% endif %}
        </div>

        <!-- STATIC GRAPH (graph_html) -->
        <div class="card mt-4 p-3 shadow-sm">
          <h4 class="text-center mb-3">ðŸ“Š Financial Performance (Static View)</h4>
          <div>{{ graph_html | safe }}</div>
        </div>

        <!-- FEATURE BUTTONS -->
        <div class="card mt-4 p-3 shadow-sm">
          <h4 class="mb-3 text-center">Financial Tools</h4>
          <div class="row g-2">
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('upload') }}" class="btn btn-primary w-100">Upload New CSV</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('manual_entry') }}" class="btn btn-success w-100">Manual Entry</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('use_demo_data') }}" class="btn btn-info w-100">Use Demo Data</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('profile') }}" class="btn btn-secondary w-100">My Profile</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('ask') }}" class="btn btn-info w-100">Business Assistant</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('admin') }}" class="btn btn-warning w-100">Admin Panel</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('profit_calculator') }}" class="btn btn-success w-100">Profit Calculator</a>
            </div>
            <div class="col-md-3 col-sm-6">
              <a href="{{ url_for('trend_forecaster') }}" class="btn btn-warning w-100">Trend Forecaster</a>
            </div>

            <!-- Download PDF Report -->
            <div class="col-md-3 col-sm-6">
              <form action="{{ url_for('download_report') }}" method="POST" class="d-grid">
                <input type="hidden" name="revenue" value="{{ kpis.total_revenue }}">
                <input type="hidden" name="expenses" value="{{ kpis.total_expenses }}">
                <input type="hidden" name="profit" value="{{ kpis.total_profit }}">
                <input type="hidden" name="margin" value="{{ kpis.profit_margin }}">
                <input type="hidden" name="advice" value="{{ advice }}">
                <button type="submit" class="btn btn-outline-secondary w-100">ðŸ“„ Download Report</button>
              </form>
            </div>
          </div>
        </div>

        <!-- SEND REPORT BY EMAIL -->
        <div class="card mt-4 p-3 shadow-sm">
          <h4 class="mb-3">ðŸ“§ Send Latest Summary</h4>
          <form action="{{ url_for('send_report') }}" method="POST" class="row g-2 align-items-center">

            <input type="hidden" name="revenue" value="{{ kpis.total_revenue }}">
            <input type="hidden" name="expenses" value="{{ kpis.total_expenses }}">
            <input type="hidden" name="profit" value="{{ kpis.total_profit }}">
            <input type="hidden" name="margin" value="{{ kpis.profit_margin }}">
            <input type="hidden" name="advice" value="{{ advice }}">

            <div class="col-md-5 col-sm-8">
              <input type="email" name="email" class="form-control" placeholder="Recipient email" required>
            </div>
            <div class="col-md-3 col-sm-4">
              <button type="submit" class="btn btn-info w-100">ðŸ“§ Send Report</button>
            </div>
          </form>
        </div>

        <!-- EXTRA: LIVE PERFORMANCE (second chart) -->
        <div class="card mt-4 p-3 shadow-sm">
          <h4 class="mb-3">ðŸ“Š Live Performance (Revenue vs Expenses)</h4>
          <div id="performanceChart" style="height:400px;"></div>
        </div>

        <!-- FOOTER -->
        <footer class="text-center py-3 mt-4 text-muted border-top">
          Â© {{ current_year }} OptiGain. All rights reserved.
        </footer>

    </div> <!-- /container-fluid -->
</div> <!-- /main-content -->

<!-- ======================= SCRIPTS ======================= -->
<script>
// ðŸŒ™ Dark Mode + persistence
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('darkToggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }
  toggleBtn?.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
});

// ðŸ’° M-Pesa Balance
async function fetchMpesaBalance() {
  try {
    const res = await fetch("/api/mpesa_balance");
    const data = await res.json();
    const balanceEl = document.getElementById("balance-amount");
    const timeEl = document.getElementById("balance-updated");

    if (data.Result && data.Result.ResultParameters) {
      const val = data.Result.ResultParameters.ResultParameter[0].Value;
      balanceEl.textContent = `${val} KSh`;
    } else if (data.balance) {
      balanceEl.textContent = `${Number(data.balance).toLocaleString()} KSh`;
    } else {
      balanceEl.textContent = "Unavailable";
    }
    if (timeEl) {
      timeEl.textContent = "Last updated: " + new Date().toLocaleTimeString();
    }
  } catch (err) {
    console.error("âš ï¸ Failed to fetch M-Pesa balance:", err);
    document.getElementById("balance-amount").textContent = "Unavailable";
  }
}

// ðŸ”¢ KPI Summary
async function loadKpiSummary() {
  try {
    const res = await fetch("/api/transactions_summary");
    const data = await res.json();
    if (data.error) return;

    document.querySelectorAll("#kpi-row .kpi-card").forEach(card => {
      const key = card.getAttribute("data-kpi");
      const valueEl = card.querySelector(".card-value");
      if (!valueEl) return;

      if (key === "total_profit" && data.total_profit != null) {
        valueEl.textContent = `${Number(data.total_profit).toLocaleString()} KSh`;
      }
      if (key === "avg_profit" && data.avg_profit != null) {
        valueEl.textContent = `${Number(data.avg_profit).toLocaleString()} KSh`;
      }
      if (key === "profit_growth" && data.profit_growth != null) {
        valueEl.textContent = `${data.profit_growth}`;
      }
      if (key === "largest_expense" && data.largest_expense != null) {
        valueEl.textContent = `${Number(data.largest_expense).toLocaleString()} KSh`;
      }
    });
  } catch (err) {
    console.error("âš ï¸ Failed to load KPI summary:", err);
  }
}

// ðŸ“‰ Live Financial Performance chart
async function loadLiveChart() {
  try {
    const res = await fetch('/api/financial_data');
    const data = await res.json();

    const months   = data.month    || [];
    const revenue  = data.revenue  || [];
    const expenses = data.expenses || [];
    const profit   = data.profit   || [];

    const traces = [
      { x: months, y: revenue,  type: 'scatter', name: 'Revenue' },
      { x: months, y: expenses, type: 'scatter', name: 'Expenses' },
      { x: months, y: profit,   type: 'scatter', name: 'Profit' }
    ];

    const layout = {
      title: 'Company Financial Trends',
      xaxis: { title: 'Period' },
      yaxis: { title: 'Amount (KSh)' },
      margin: { t: 40, l: 50, r: 30, b: 50 }
    };

    Plotly.newPlot('liveChart', traces, layout);
  } catch (err) {
    console.error("âš ï¸ Failed to load live chart:", err);
  }
}

// ðŸ“Š Forecast chart + AI annotations
function initForecastChart() {
  const raw = '{{ forecast_chart | safe }}';
  let forecastData = [];
  try { forecastData = JSON.parse(raw) || []; } catch(e) { forecastData = []; }

  const labels   = forecastData.map(i => i.date);
  const revenue  = forecastData.map(i => Number(i.predicted_revenue || 0));
  const profit   = forecastData.map(i => Number(i.profit || 0));
  const expenses = forecastData.map(i => Number(i.expenses || 0));

  const metricMap = { predicted_revenue: revenue, profit, expenses };

  const initial = {
    x: labels,
    y: revenue,
    type: 'bar',
    name: 'Revenue'
  };

  const isDark = document.body.classList.contains('dark-mode');
  const baseLayout = {
    title: 'Financial Forecast',
    plot_bgcolor: isDark ? '#222' : '#fff',
    paper_bgcolor: isDark ? '#222' : '#fff',
    font: { color: isDark ? '#fff' : '#000' }
  };

  Plotly.newPlot('forecastPlotly', [initial], baseLayout);

  // AI annotations
  const notificationsList = {{ notifications | tojson | safe }};
  let annotations = [];
  if (notificationsList && notificationsList.length > 0 && labels.length > 0) {
    annotations = notificationsList.map((note, idx) => {
      const xIndex = idx % labels.length;
      return {
        x: labels[xIndex],
        y: revenue[xIndex] || 0,
        text: note.length > 60 ? note.slice(0, 60) + "â€¦" : note,
        showarrow: true,
        arrowhead: 5,
        ax: 0,
        ay: -40,
        bgcolor: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,0,0.2)',
        bordercolor: '#ffcc00',
        font: { color: isDark ? '#fff' : '#222', size: 12 }
      };
    });
    Plotly.relayout('forecastPlotly', { annotations });
  }

  // metric dropdown
  const select = document.getElementById('metricSelect');
  select?.addEventListener('change', (e) => {
    const val = e.target.value;
    const newY = metricMap[val] || revenue;
    Plotly.update('forecastPlotly',
      { y: [newY], name: val },
      { title: `Financial Forecast - ${val.replace('_',' ').toUpperCase()}` }
    );
  });

  // react to dark-mode toggle
  const toggleBtn = document.getElementById('darkToggle');
  toggleBtn?.addEventListener('click', () => {
    const darkNow = document.body.classList.contains('dark-mode');
    const newLayout = {
      plot_bgcolor: darkNow ? '#222' : '#fff',
      paper_bgcolor: darkNow ? '#222' : '#fff',
      font: { color: darkNow ? '#fff' : '#000' }
    };
    const newAnnotations = annotations.map(a => ({
      ...a,
      bgcolor: darkNow ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,0,0.2)',
      font: { ...(a.font || {}), color: darkNow ? '#fff' : '#222' }
    }));
    Plotly.relayout('forecastPlotly', { ...newLayout, annotations: newAnnotations });
  });
}

// ðŸ“Š Second chart: Revenue vs Expenses only
async function loadPerformanceChart() {
  try {
    const res = await fetch('/api/financial_data');
    const data = await res.json();

    const months   = data.month    || [];
    const revenue  = data.revenue  || [];
    const expenses = data.expenses || [];

    if (months.length === 0) {
      document.getElementById('performanceChart').innerHTML =
        "<p class='text-center text-muted'>No data available yet.</p>";
      return;
    }

    const trace1 = { x: months, y: revenue,  type: 'scatter', name: 'Revenue' };
    const trace2 = { x: months, y: expenses, type: 'scatter', name: 'Expenses' };

    const layout = {
      title: 'Live Performance (Revenue vs Expenses)',
      xaxis: { title: 'Period' },
      yaxis: { title: 'Amount (KSh)' },
      margin: { t: 40, l: 60, r: 30, b: 40 }
    };

    Plotly.newPlot('performanceChart', [trace1, trace2], layout);
  } catch (err) {
    console.error("âš ï¸ Failed to load performance chart:", err);
  }
}

// ðŸ” AI insights auto-refresh (list text)
async function loadInsights() {
  try {
    const res = await fetch('/api/ai_insights');
    const data = await res.json();
    const container = document.querySelector('.notification ul');
    if (container && Array.isArray(data)) {
      container.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        container.appendChild(li);
      });
    }
  } catch (err) {
    console.error("AI Insights refresh failed:", err);
  }
}

// INIT
document.addEventListener('DOMContentLoaded', () => {
  fetchMpesaBalance();
  loadKpiSummary();
  loadLiveChart();
  initForecastChart();
  loadPerformanceChart();
  loadInsights();

  // refresh intervals
  setInterval(fetchMpesaBalance, 20000);
  setInterval(loadKpiSummary, 20000);
  setInterval(loadLiveChart, 10000);
  setInterval(loadPerformanceChart, 5 * 60 * 1000);
  setInterval(loadInsights, 20000);
});
</script>

</body>
</html>