<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="60">
    <title>Dashboard - OptiGain</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body class="min-h-screen flex transition-colors">


<!-- MOBILE SIDEBAR OVERLAY -->
<div id="mobileSidebarOverlay"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-40"></div>

<!-- SIDEBAR -->
<aside id="sidebar"
       class="fixed z-50 inset-y-0 left-0 w-60 shadow-xl transform 
              -translate-x-full md:translate-x-0 transition-all duration-300"
       style="background: var(--og-surface); color: var(--og-text-main);">

    <div class="p-6 flex flex-col items-center">
        <img src="{{ url_for('static', filename='logo.png') }}" class="w-20 mb-2">
        <h2 class="font-bold text-xl" style="color: var(--og-primary);">OptiGain</h2>
    </div>

    <nav class="mt-4 px-4 space-y-2">

        <a href="{{ url_for('dashboard') }}"
           class="block p-3 rounded-md font-semibold transition hover:text-white"
           onmouseover="this.style.background='var(--og-primary)'"
           onmouseout="this.style.background='transparent'">
          
           ðŸ“Š Dashboard
        </a>

        <!-- REVENUE -->
<div>
    <button type="button"
        onclick="toggleMenu('revenueMenu',this)"
        class="w-full flex justify-between items-center p-3 font-semibold rounded-md
               transition hover:text-white"
        onmouseover="this.style.background='var(--og-primary)'"
        onmouseout="this.style.background='transparent'">
        <span>ðŸ’° Revenue</span><span>â–¾</span>
    </button>

    <div id="revenueMenu" class="ml-4 mt-1 hidden space-y-1">

        <a href="{{ url_for('revenue_overview') }}"
           class="block p-2 text-sm rounded hover:text-white"
           onmouseover="this.style.background='var(--og-primary)'"
           onmouseout="this.style.background='transparent'">
           Overview
        </a>

        <a href="{{ url_for('cash_revenue_entry') }}"
           class="block p-2 text-sm rounded hover:text-white"
           onmouseover="this.style.background='var(--og-primary)'"
           onmouseout="this.style.background='transparent'">
           âž• Add Cash Revenue
        </a>

        <a href="{{ url_for('revenue_entry') }}"
           class="block p-2 text-sm rounded hover:text-white"
           onmouseover="this.style.background='var(--og-primary)'"
           onmouseout="this.style.background='transparent'">
           Split revenue
        </a>

    </div>
</div>

        <!-- EXPENSES -->
        <div>
            <button type="button"
                onclick="toggleMenu('expensesMenu', this)"
                class="w-full flex justify-between items-center p-3 font-semibold rounded-md
                       transition hover:text-white"
                onmouseover="this.style.background='var(--og-primary)'"
                onmouseout="this.style.background='transparent'">
                <span>âž– Expenses</span><span>â–¾</span>
            </button>

            <div id="expensesMenu" class="ml-4 mt-1 hidden space-y-1">
                <a href="{{ url_for('expense_entry') }}"
                   class="block p-2 text-sm rounded hover:text-white"
                   onmouseover="this.style.background='var(--og-primary)'"
                   onmouseout="this.style.background='transparent'">
                   Add Expense
                </a>
            </div>
        </div>

<!-- INVENTORY -->
<div>
  <button type="button"
      onclick="toggleMenu('inventoryMenu',this)"
      class="w-full flex justify-between items-center p-3 font-semibold rounded-md
             transition hover:text-white"
      onmouseover="this.style.background='var(--og-primary)'"
      onmouseout="this.style.background='transparent'">
      <span>ðŸ“¦ Inventory</span><span>â–¾</span>
  </button>

  <div id="inventoryMenu" class="ml-4 mt-1 hidden space-y-1">

    <a href="{{ url_for('inventory_setup') }}"
       class="block p-2 text-sm rounded hover:text-white"
       onmouseover="this.style.background='var(--og-primary)'"
       onmouseout="this.style.background='transparent'">
       Setup Inventory
    </a>

    <a href="{{ url_for('inventory_adjust') }}"
       class="block p-2 text-sm rounded hover:text-white"
       onmouseover="this.style.background='var(--og-primary)'"
       onmouseout="this.style.background='transparent'">
       ðŸ§¾ Inventory Adjustment
    </a>

  </div>
</div>
        <!-- FORECASTING -->
<div>
  <button type="button"
      onclick="toggleMenu('forecastMenu',this)"
      class="w-full flex justify-between items-center p-3 font-semibold rounded-md
             transition hover:text-white"
      onmouseover="this.style.background='var(--og-primary)'"
      onmouseout="this.style.background='transparent'">
      <span>ðŸ“ˆ Forecasting</span><span>â–¾</span>
  </button>

  <div id="forecastMenu" class="ml-4 mt-1 hidden space-y-1">

    <a href="{{ url_for('trend_forecaster') }}"
       class="block p-2 text-sm rounded hover:text-white"
       onmouseover="this.style.background='var(--og-primary)'"
       onmouseout="this.style.background='transparent'">
       Trend Forecaster
    </a>

    <a href="{{ url_for('profit_calculator') }}"
       class="block p-2 text-sm rounded hover:text-white"
       onmouseover="this.style.background='var(--og-primary)'"
       onmouseout="this.style.background='transparent'">
       Profit Calculator
    </a>

  </div>
</div>
        <a href="{{ url_for('ask') }}"
   class="block p-3 rounded-md font-semibold transition hover:text-white"
   onmouseover="this.style.background='var(--og-primary)'"
   onmouseout="this.style.background='transparent'">
   ðŸ¤– Business Assistant
</a>

<a href="{{ url_for('profile') }}"
   class="block p-3 rounded-md font-semibold transition hover:text-white"
   onmouseover="this.style.background='var(--og-primary)'"
   onmouseout="this.style.background='transparent'">
   ðŸ‘¤ My Profile
</a>

<a href="{{ url_for('logout') }}"
   class="block p-3 rounded-md font-semibold transition hover:text-white"
   onmouseover="this.style.background='var(--og-primary)'"
   onmouseout="this.style.background='transparent'">
   ðŸšª Logout
</a>

    </nav>
</aside>

<!-- MAIN CONTENT (SCROLL FIX APPLIED HERE) -->
<div class="flex-1 md:ml-60 p-4 md:p-6 transition-all overflow-y-auto h-screen">

    <!-- TOP BAR -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <button id="sidebarToggle" class="md:hidden text-2xl">â˜°</button>
            <h1 class="text-lg font-semibold">Welcome, {{ session['username'] }}</h1>
        </div>
        <button id="darkToggle"
                class="w-10 h-10 rounded-full shadow"
                style="background: var(--og-primary); color:white;">ðŸŒ™</button>
    </div>

   <!-- TOTAL REVENUE (LIVE) -->
<section class="max-w-sm mb-4">
    <div class="rounded-lg px-4 py-3 shadow"
         style="background: var(--og-surface); border-left: 4px solid var(--og-primary);">
        
        <h5 class="text-xs uppercase opacity-60 tracking-wide">
            ðŸ’° Total Revenue (Live)
        </h5>

        <p class="text-2xl font-semibold text-green-600 mt-1">
            KSh {{ live_total_revenue | int }}
        </p>

        <p class="text-xs opacity-70 mt-1">
            All confirmed payments received
        </p>
    </div>
</section>

    <!-- KPI CARDS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4 mb-6">
        {% for title, value in [
          ('Total Profit',kpis.total_profit),
          ('Average Profit',kpis.avg_profit),
          ('Total Expenses',kpis.total_expenses),
          ('Profit Growth',kpis.profit_growth),
          ('Largest Expense',kpis.largest_expense)
        ] %}
        <div class="p-5 rounded-xl shadow" style="background: var(--og-surface);">
            <h5 class="text-[11px] uppercase opacity-60 tracking-wide">{{ title }}</h5>
            <p class="text-2xl font-semibold leading-tight tracking-tight">{{ value }}</p>
        </div>
        {% endfor %}
        </div>
	
	</section>

        

   <!-- ðŸ§  INTELLIGENCE ROW -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">

  <div class="p-5 rounded-xl shadow"
     style="background: var(--og-surface);">

  <h3 class="text-lg font-semibold mb-2">
    ðŸ“Š Revenue Intelligence
  </h3>

  <p><strong>Locked days:</strong> {{ intelligence.locked_days }}</p>
  <p><strong>Anomaly days:</strong> {{ intelligence.anomaly_days }}</p>
  <p><strong>MPesa days:</strong> {{ intelligence.mpesa_days }}</p>

  <hr class="my-3 opacity-30">

  {% if intelligence.locked_days < 7 %}
      <p class="text-red-500 font-semibold">
        ðŸ”´ System learning â€” lock more days
      </p>

      <p class="text-xs opacity-70">
        AI insights activate after 7 locked days
      </p>

  {% elif intelligence.locked_days < 14 %}
      <p class="text-yellow-500 font-semibold">
        ðŸŸ¡ Forecast building confidence
      </p>

  {% else %}
      <p class="text-green-600 font-semibold">
        ðŸŸ¢ AI fully active
      </p>
  {% endif %}

</div>

</div>

<!-- ðŸ“Š CHART SHORTCUTS -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">

  {% if not forecast_status.ready %}

  <!-- LOCKED -->
  <div class="block p-5 rounded-xl shadow opacity-60 cursor-not-allowed"
       style="background: var(--og-surface); border-left: 4px solid #ef4444;">

    <h4 class="text-lg font-semibold mb-1">ðŸ“ˆ Revenue Forecast</h4>

    <p class="text-sm opacity-70 mb-3">
      Forecast locked â€” system still learning
    </p>

    <div class="text-sm text-red-500 font-medium">
      ðŸ”’ {{ forecast_status.days }} / 7 locked days
    </div>
  </div>

{% else %}

  <!-- ACTIVE -->
  <a href="{{ url_for('revenue_forecast') }}"
     class="block p-5 rounded-xl shadow transition hover:scale-[1.01]"
     style="background: var(--og-surface); border-left: 4px solid #22c55e;">

    <h4 class="text-lg font-semibold mb-1">ðŸ“ˆ Revenue Forecast</h4>

    <p class="text-sm opacity-70 mb-2">
      Forecast horizon: {{ forecast_status.horizon }} days
    </p>

    <p class="text-sm mb-3">
      Confidence: 
      {% if forecast_status.confidence == "Low" %}
        <span class="text-yellow-500 font-medium">Low</span>
      {% elif forecast_status.confidence == "Medium" %}
        <span class="text-orange-500 font-medium">Medium</span>
      {% else %}
        <span class="text-green-600 font-medium">High</span>
      {% endif %}
    </p>

    <div class="text-sm font-medium"
         style="color: var(--og-primary);">
      View forecast â†’
    </div>
  </a>

{% endif %}

  <!-- Live Performance Card -->
  <a href="{{ url_for('live_performance') }}"
     class="block p-5 rounded-xl shadow transition hover:scale-[1.01]"
     style="background: var(--og-surface);">

    <h4 class="text-lg font-semibold mb-1">ðŸ“‰ Live Financial Performance</h4>
    <p class="text-sm opacity-70 mb-3">
      Revenue vs expenses over time
    </p>

    <div class="text-sm font-medium"
         style="color: var(--og-primary);">
      Tap to view chart â†’
    </div>
  </a>


</div>

<section class="mt-8 p-5 rounded-xl shadow"
         style="background: var(--og-surface);">

  <h2 class="text-lg font-semibold mb-3">
    ðŸ“‚ Your Uploaded Files
  </h2>

  {% if files %}
    <ul class="list-disc ml-5">
      {% for file in files %}
        <li>
          <a href="{{ url_for('view_file', filename=file) }}"
             class="font-medium"
             style="color: var(--og-primary);">
             {{ file }}
          </a>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="opacity-70">No files uploaded yet.</p>
  {% endif %}

</section>

<script>
function toggleMenu(id,btn) {
  const el = document.getElementById(id);
  if (!el) return;
  
  el.classList.toggle("hidden");
  btn.classList.toggle("active-menu");
}

const sidebar = document.getElementById("sidebar");
const toggle = document.getElementById("sidebarToggle");
const overlay = document.getElementById("mobileSidebarOverlay");

toggle?.addEventListener("click", () => {
  sidebar.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
});
overlay?.addEventListener("click", () => {
  sidebar.classList.add("-translate-x-full");
  overlay.classList.add("hidden");
});

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("darkToggle");
  const root = document.documentElement;
  if (localStorage.getItem("theme") === "dark") root.classList.add("dark");
  btn.addEventListener("click", () => {
    const dark = root.classList.toggle("dark");
    localStorage.setItem("theme", dark ? "dark" : "light");
  });
});
</script>

<script>
  async function pollLatestPayment() {
    try {
      const res = await fetch("/api/latest-payment");
      const data = await res.json();

      if (data.payment) {
        showPaymentPopup(data.payment.amount);
        refreshKPIs();
      }
    } catch (e) {
      console.error("Polling error:", e);
    }
  }

  function showPaymentPopup(amount) {
    const popup = document.createElement("div");
    popup.className =
      "fixed top-5 right-5 bg-green-600 text-white px-4 py-3 rounded-lg shadow-lg z-50";
    popup.innerText = `ðŸ’° Payment received: KSh ${amount}`;

    document.body.appendChild(popup);

    setTimeout(() => popup.remove(), 4000);
  }

  function refreshKPIs() {
    // simplest approach for now
    window.location.reload();
  }

  // Poll every 5 seconds
  setInterval(pollLatestPayment, 5000);
</script>

<script>
setInterval(function(){
    fetch("/api/dashboard-snapshot")
    .then(r=>r.json())
    .then(data=>{
        document.getElementById("profit").innerText=data.total_profit;
    });
},5000);
</script>

</body>
</html>