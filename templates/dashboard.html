<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Profit Optimizer</title>
    <!-- ‚úÖ Link external stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <div class="top-bar">
        <h1>Welcome, {{ session['user'] }}</h1>
<!-- üåô Dark Mode Toggle -->
<button id="darkToggle" class="dark-toggle">üåô Dark Mode</button>
    </div>

<!-- üí∞ Live Balance Section -->
<div id="live-balance" style="margin:10px; font-weight:bold;">
  üí∞ Live Balance: <span id="balance-amount">Loading...</span>
</div>

<!-- üîπ KPI Section -->
<div class="kpi-container" style="display: flex; gap: 20px; margin-bottom: 20px;">
  <div class="kpi-card" style="flex:1; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center;">
    <h3>Total Profit</h3>
    <p style="font-size:24px; font-weight:bold;">{{ kpis.total_profit }}</p>
  </div>
  <div class="kpi-card" style="flex:1; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center;">
    <h3>Average Profit</h3>
    <p style="font-size:24px; font-weight:bold;">{{ kpis.avg_profit }}</p>
  </div>
  <div class="kpi-card" style="flex:1; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center;">
    <h3>Profit Growth</h3>
    <p style="font-size:24px; font-weight:bold;">{{ kpis.profit_growth }}</p>
  </div>
  <div class="kpi-card" style="flex:1; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center;">
    <h3>Largest Expense</h3>
    <p style="font-size:24px; font-weight:bold;">{{ kpis.largest_expense }}</p>
  </div>
</div>
<!-- üîπ End KPI Section -->

<div class="card">
  <h2>üìà Revenue Forecast (Next 6 Months)</h2>
  <ul>
    {% for item in forecast_data %}
      <li>{{ item.date }} ‚Üí {{ item.predicted_revenue }}</li>
    {% endfor %}
  </ul>
</div>

<div class="card mt-4 p-3 shadow rounded-3">
  <h4 class="mb-3 text-center">üìà Live Financial Performance</h4>
  <div id="liveChart" style="height: 400px;"></div>
</div>

<div class="card mt-4 p-3 shadow rounded-3">
  <h4 class="mb-3 text-center">üìà Live Financial Performance</h4>
  <div id="liveChart" style="height: 400px;"></div>
</div>

<!-- üß† Smart AI Insights Section -->
{% if notifications %}
    <div class="notification" style="background:#fff; padding:15px; border-radius:10px; margin:5px 0; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
        <strong>üß† Smart Notifications:</strong>
        <ul style="margin-top:10px;">
            {% for note in notifications %}
                <li>{{ note }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div id="mpesaBalance" style="background:#fff;padding:10px;margin:10px 0;border-radius:8px;">
  <h3>üì± M-Pesa Business Balance</h3>
  <p id="balanceValue">Fetching balance...</p>
</div>

<script>
fetch("/api/mpesa_balance")
  .then(r => r.json())
  .then(data => {
      if(data.Result){
          document.getElementById("balanceValue").innerText =
              data.Result.ResultParameters.ResultParameter[0].Value || "Unavailable";
      } else {
          document.getElementById("balanceValue").innerText = JSON.stringify(data);
      }
  })
  .catch(err => document.getElementById("balanceValue").innerText = "Error loading balance");
</script>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
async function loadChart() {
  const res = await fetch('/api/financial_data');
  const data = await res.json();

  const months = data.month || [];
  const revenue = data.revenue || [];
  const expenses = data.expenses || [];
  const profit = data.profit || [];

  const trace1 = { x: months, y: revenue, type: 'scatter', name: 'Revenue' };
  const trace2 = { x: months, y: expenses, type: 'scatter', name: 'Expenses' };
  const trace3 = { x: months, y: profit, type: 'scatter', name: 'Profit' };

  const layout = {
    title: 'Company Financial Trends',
    xaxis: { title: 'Month' },
    yaxis: { title: 'Amount (KSh)' },
    plot_bgcolor: '#f9f9f9',
    paper_bgcolor: '#fff',
    margin: { t: 40, l: 50, r: 30, b: 50 }
  };

  Plotly.newPlot('liveChart', [trace1, trace2, trace3], layout);
}

// Refresh every 10 seconds
loadChart();
setInterval(loadChart, 10000);
</script>

<h3>üìä Revenue Forecast Trend</h3>
<div id="forecastPlotly" style="width: 100%; height: 500px;"></div>

<!-- Dropdown Filter -->
<div style="margin:10px 0;">
  <label for="metricSelect">Select Metric:</label>
  <select id="metricSelect">
      <option value="predicted_revenue">Revenue</option>
      <option value="profit">Profit</option>
      <option value="expenses">Expenses</option>
  </select>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const forecastData = JSON.parse('{{ forecast_chart | safe }}') || [];

    // Extract arrays for plotting
    const labels = forecastData.map(item => item.date);
    const revenue = forecastData.map(item => parseFloat(item.predicted_revenue || 0));
    const profit = forecastData.map(item => parseFloat(item.profit || 0));
    const expenses = forecastData.map(item => parseFloat(item.expenses || 0));

    const metricMap = { 'predicted_revenue': revenue, 'profit': profit, 'expenses': expenses };

    const plotData = [{
        x: labels,
        y: revenue,
        type: 'bar',
        name: 'Revenue',
        marker: { color: 'rgba(0, 123, 255, 0.7)' }
    }];

    const layout = {
        title: 'Financial Forecast',
        plot_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        paper_bgcolor: document.body.classList.contains('dark-mode') ? '#222' : '#fff',
        font: { color: document.body.classList.contains('dark-mode') ? '#fff' : '#000' }
    };

    Plotly.newPlot('forecastPlotly', plotData, layout);

// üß† Add AI Insight Overlays
const notificationsList = {{ notifications | tojson | safe }};
const annotations = [];

if (notificationsList && notificationsList.length > 0) {
    notificationsList.forEach((note, idx) => {
        // Position the annotation evenly along the chart
        const xIndex = idx % labels.length;
        annotations.push({
            x: labels[xIndex],
            y: revenue[xIndex] || 0,
            text: note.length > 60 ? note.slice(0, 60) + "‚Ä¶" : note,
            showarrow: true,
            arrowhead: 5,
            ax: 0,
            ay: -40,
            bgcolor: 'rgba(255,255,0,0.2)',
            bordercolor: '#ffcc00',
            font: { color: '#222', size: 12 }
        });
    });

    Plotly.relayout('forecastPlotly', { annotations });
}

    // Dropdown Filter
    document.getElementById('metricSelect').addEventListener('change', (e) => {
        const selected = e.target.value;
        const newY = metricMap[selected] || revenue;
        Plotly.update('forecastPlotly', { y: [newY], name: selected }, { title: `Financial Forecast - ${selected.replace('_', ' ').toUpperCase()}` });
    });

    // Dark Mode toggle sync
    const toggleBtn = document.getElementById('darkToggle');
    toggleBtn?.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-mode');
        Plotly.update('forecastPlotly', {}, {
            plot_bgcolor: isDark ? '#222' : '#fff',
            paper_bgcolor: isDark ? '#222' : '#fff',
            font: { color: isDark ? '#fff' : '#000' }
        });
    });
// Update annotations in dark mode
const updateAnnotationColors = (isDark) => {
    const annos = annotations.map(a => ({
        ...a,
        bgcolor: isDark ? 'rgba(0,0,0,0.6)' : 'rgba(255,255,0,0.2)',
        font: { color: isDark ? '#fff' : '#222', size: 12 }
    }));
    Plotly.relayout('forecastPlotly', { annotations: annos });
};

toggleBtn?.addEventListener('click', () => {
    const isDark = document.body.classList.contains('dark-mode');
    updateAnnotationColors(isDark);
});
});
</script>
    {% if notifications %}
        <div class="notification">
            <strong>Smart Notifications:</strong>
            <ul>
                {% for note in notifications %}
                    <li>{{ note }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

    <!-- ‚úÖ Uploaded Files -->
    <div class="file-list">
        <h2>Your Uploaded Files:</h2>
        {% if files %}
            <ul>
                {% for file in files %}
                    <li><a href="{{ url_for('view_file', filename=file) }}">{{ file }}</a></li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No files uploaded yet.</p>
        {% endif %}
    </div>

  <!-- ‚úÖ Feature Buttons -->
<div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
  <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload New CSV</a>
  <a href="{{ url_for('manual_entry') }}" class="btn btn-success">Manual Entry</a>
  <a href="{{ url_for('use_demo_data') }}" class="btn btn-primary">Use Demo Data</a>
  <a href="{{ url_for('profile') }}" class="btn btn-info">My Profile</a>
  <a href="{{ url_for('ask') }}" class="btn btn-info">Ask ChatGPT</a>
  <a href="{{ url_for('admin') }}" class="btn btn-warning">Admin Panel</a>
  <a href="{{ url_for('profit_calculator') }}" class="btn btn-success">Profit Calculator</a>
  <a href="{{ url_for('trend_forecaster') }}" class="btn btn-warning">Trend Forecaster</a>

  <!-- üìÑ Download Report Button -->
  <form action="{{ url_for('download_report') }}" method="POST" style="display:inline;">
      <input type="hidden" name="revenue" value="{{ kpis.total_revenue }}">
      <input type="hidden" name="expenses" value="{{ kpis.total_expenses }}">
      <input type="hidden" name="profit" value="{{ kpis.total_profit }}">
      <input type="hidden" name="margin" value="{{ kpis.profit_margin }}">
      <input type="hidden" name="advice" value="{{ advice }}">
      <button type="submit" class="btn btn-secondary">üìÑ Download Report</button>
  </form>
</div>
<h2>Ask ChatGPT</h2>
<form action="/dashboard" method="post">
  <input type="text" name="question" placeholder="Ask something..." required>
  <button type="submit">Ask</button>
</form>

{% if answer %}
  <h3>Answer:</h3>
  <p>{{ answer }}</p>
{% endif %}

    



<!-- ‚úÖ Navbar with Logo & Branding -->
<nav style="background-color:#0275d8; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; color:white;">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="OptiGain Logo" style="height:40px;">
        <h2 style="margin:0;">OptiGain</h2>
    </div>
    <div>
        <form action="{{ url_for('logout') }}" method="get" style="margin:0;">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</nav>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('darkToggle');
  const savedTheme = localStorage.getItem('theme');

  // Apply saved mode on load
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }

  // Toggle and save mode
  toggleBtn?.addEventListener('click', () => {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // üîÅ Auto-refresh KPI + chart data every 15 seconds
  async function refreshLiveData() {
    try {
      const res = await fetch('/api/financial_data');
      const data = await res.json();

      // Update KPI cards dynamically
      document.querySelectorAll('.kpi-card h3').forEach(card => {
        const label = card.textContent.trim();
        const valueElem = card.nextElementSibling;

        if (label === 'Total Profit') valueElem.textContent = data.total_profit || '‚Äî';
        if (label === 'Average Profit') valueElem.textContent = data.avg_profit || '‚Äî';
        if (label === 'Profit Growth') valueElem.textContent = data.profit_growth || '‚Äî';
        if (label === 'Largest Expense') valueElem.textContent = data.largest_expense || '‚Äî';
      });

      // Update chart
      if (data.month && data.revenue && data.expenses && data.profit) {
        Plotly.react('liveChart', [
          { x: data.month, y: data.revenue, type: 'scatter', name: 'Revenue' },
          { x: data.month, y: data.expenses, type: 'scatter', name: 'Expenses' },
          { x: data.month, y: data.profit, type: 'scatter', name: 'Profit' }
        ], {
          title: 'Company Financial Trends',
          xaxis: { title: 'Month' },
          yaxis: { title: 'Amount (KSh)' }
        });
      }

    } catch (err) {
      console.error('‚ö†Ô∏è Live data refresh failed:', err);
    }
  }

  // üí∞ Live M-Pesa Balance refresh
  async function fetchBalance() {
    try {
      const res = await fetch('/api/mpesa_balance');
      const data = await res.json();
      document.getElementById('balance-amount').textContent =
        data.balance ? `${data.balance.toLocaleString()} KSh` : 'Unavailable';
    } catch {
      document.getElementById('balance-amount').textContent = 'Unavailable';
    }
  }

  // Refresh every 15‚Äì20 seconds
  setInterval(refreshLiveData, 15000);
  setInterval(fetchBalance, 20000);

  // Initial load
  refreshLiveData();
  fetchBalance();
});
</script>

<script>
async function refreshDashboard() {
  try {
    const res = await fetch('/api/dashboard_data');
    const data = await res.json();

    // ‚úÖ Update KPIs
    document.querySelectorAll('.kpi-card h3').forEach((el, i) => {
      const key = Object.keys(data.kpis)[i];
      el.nextElementSibling.innerText = data.kpis[key];
    });

    // ‚úÖ Update M-Pesa balance
    document.getElementById("balanceValue").innerText =
      "KSh " + data.mpesa_balance.toLocaleString();

    // ‚úÖ Update Chart
    const trace1 = { x: data.chart.months, y: data.chart.revenue, type: 'scatter', name: 'Revenue' };
    const trace2 = { x: data.chart.months, y: data.chart.expenses, type: 'scatter', name: 'Expenses' };
    const trace3 = { x: data.chart.months, y: data.chart.profit, type: 'scatter', name: 'Profit' };
    const layout = {
      title: 'Company Financial Trends',
      xaxis: { title: 'Month' },
      yaxis: { title: 'Amount (KSh)' }
    };
    Plotly.newPlot('liveChart', [trace1, trace2, trace3], layout);

  } catch (err) {
    console.error("Dashboard refresh failed:", err);
  }
}

// Refresh every 10 seconds
refreshDashboard();
setInterval(refreshDashboard, 10000);
</script>

<script>
async function loadInsights() {
  try {
    const res = await fetch('/api/ai_insights');
    const data = await res.json();

    const container = document.querySelector('.notification ul');
    if (container && Array.isArray(data)) {
      container.innerHTML = '';
      data.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        container.appendChild(li);
      });
    }
  } catch (err) {
    console.error("AI Insights refresh failed:", err);
  }
}

// Refresh AI insights every 20 seconds
loadInsights();
setInterval(loadInsights, 20000);
</script>

</body>
</html>