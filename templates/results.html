<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OptiGain Financial Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind output -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
</head>

<body class="min-h-screen flex bg-sky-50 text-slate-800 dark:bg-slate-950 dark:text-white transition-colors">
<!-- MOBILE SIDEBAR OVERLAY -->
<div id="mobileSidebarOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-40"></div>

<!-- SIDEBAR -->
<aside id="sidebar"
       class="fixed inset-y-0 left-0 w-60 bg-white dark:bg-slate-900 
              text-slate-700 dark:text-slate-200 shadow-xl z-50 transform 
              -translate-x-full md:translate-x-0 transition-all duration-300">
    <div class="p-6 flex flex-col items-center">
        <img src="{{ url_for('static', filename='logo.png') }}" class="w-20 mb-2" alt="OptiGain Logo">
        <h2 class="text-og-primary dark:text-blue-400 font-bold text-xl">OptiGain</h2>
    </div>

    <nav class="mt-4 px-4 space-y-1">
        <a href="{{ url_for('dashboard') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ“Š Dashboard</a>
        <a href="{{ url_for('upload') }}"  class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ“¤ Upload CSV</a>
        <a href="{{ url_for('manual_entry') }}"  class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">â• Manual Entry</a>
        <a href="{{ url_for('trend_forecaster') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ“ˆ Trend Forecaster</a>
        <a href="{{ url_for('profit_calculator') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ’µ Profit Calculator</a>
        <a href="{{ url_for('ask') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ¤– Business Assistant</a>
        <a href="{{ url_for('admin') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ›  Admin Panel</a>
        <a href="{{ url_for('profile') }}"  class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸ‘¤ My Profile</a>
        <a href="{{ url_for('logout') }}" class="block p-3 rounded-md font-semibold text-slate-700 dark:text-slate-300 hover:bg-blue-600 hover:text-white transition">ğŸšª Logout</a>
    </nav>
</aside>

<!-- MAIN CONTENT -->
<div class="flex-1 md:ml-60 p-4 md:p-6 bg-sky-50 dark:bg-slate-950">

  <!-- Top Bar -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-slate-900 dark:text-slate-300">Financial Summary</h1>
      <p class="text-slate-600 dark:text-slate-300 text-sm">
        File: <strong>{{ filename }}</strong>
      </p>
    </div>

    <div class="flex items-center gap-2">
      <a href="{{ url_for('dashboard') }}"
         class="px-3 py-2 bg-gray-200 dark:bg-gray-700 dark:text-slate-300 rounded shadow text-sm">
         â¬… Back
      </a>
      <button id="darkToggle" aria-pressed="false" title="Toggle theme" class="w-10 h-10 rounded-full bg-og-primary text-white dark:bg-blue-600 shadow">ğŸŒ™</button>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="p-3 mb-4 rounded bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-slate-300">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- MAIN SUMMARY CARD -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg mb-6">
      <div class="bg-og-primary dark:bg-blue-600 text-white rounded-t-lg p-4 flex flex-col md:flex-row md:justify-between md:items-center gap-3">
        <h4 class="font-semibold text-lg">ğŸ“Š Financial Summary</h4>
        <a href="{{ url_for('dashboard') }}" class="text-white underline text-sm">Back to Dashboard</a>
      </div>

      <div class="p-6">

        <!-- Action Buttons -->
        <div class="relative inline-block">
  <button
    id="actionToggle"
    type="button"
    class="
      inline-flex items-center gap-2
      px-4 py-2
      text-sm font-semibold
      text-slate-700 dark:text-slate-100
      bg-white dark:bg-slate-800
      border border-slate-300 dark:border-slate-700
      rounded-lg shadow-sm
      hover:bg-slate-50 dark:hover:bg-slate-700
      transition
    "
  >
    âš™ Actions
    <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" stroke-width="2"
         viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
    </svg>
  </button>

  <!-- Dropdown -->
  <div
    id="actionMenu"
    class="
      hidden absolute left-0 mt-2 w-56
      bg-white dark:bg-slate-800
      border border-slate-200 dark:border-slate-700
      rounded-lg shadow-lg
      z-50
    "
  >

    <a href="{{ url_for('preview_file', filename=filename) }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ‘ View Raw Data
    </a>

    <a href="{{ url_for('download_excel', filename=filename) }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ“Š Download Excel
    </a>

    <a href="{{ url_for('download_csv', filename=filename) }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ“„ Raw CSV
    </a>

    <a href="{{ url_for('download_cleaned', filename=filename) }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ§¹ Cleaned CSV
    </a>

    <a href="{{ url_for('download_raw_pdf', filename=filename) }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ“• PDF Summary
    </a>

    <a href="{{ url_for('download_full_report') }}"
       class="block px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">
      ğŸ§¾ Full Report
    </a>

    <div class="border-t border-slate-200 dark:border-slate-700 my-1"></div>

    <a href="{{ url_for('manual_entry', filename=filename) }}"
       class="block px-4 py-2 text-sm font-semibold text-blue-600 dark:text-blue-400 hover:bg-slate-100 dark:hover:bg-slate-700">
      â• Add Row
    </a>
  </div>
</div>
  
        <!-- KPI CARDS -->

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">

  <div class="results-kpi p-4 rounded-lg shadow bg-white dark:bg-slate-800/60">
    <h6>Total Revenue</h6>
    <h5 class="text-xl font-bold">KSh {{revenue}}</h5>
  </div>

  <div class="results-kpi p-4 rounded-lg shadow bg-white dark:bg-slate-800/60">
    <h6>Total Expenses</h6>
    <h5 class="text-xl font-bold">KSh{{expenses}}</h5>
  </div>

  <div class="results-kpi p-4 rounded-lg shadow bg-white dark:bg-slate-800/60">
    <h6>Total Profit</h6>
    <h5 class="text-xl font-bold">KSh{{profit}}</h5>
  </div>

  <div class="results-kpi p-4 rounded-lg shadow bg-white dark:bg-slate-800/60">
    <h6>Profit Margin</h6>
    <h5 class="text-xl font-bold">%{{margin}}</h5>
    </h5>
  </div>

</div>

  <!-- FILTER SECTION -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
      {% if categories %}
      <form method="get" class="mb-4">
        <label class="font-semibold text-slate-800 dark:text-slate-100">Filter by Category:</label>
        <select name="category" onchange="this.form.submit()"
                class="ml-2 p-2 border rounded bg-white dark:bg-slate-700 dark:text-slate-300">
            <option value="">-- All --</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>
                {{ cat }}
              </option>
            {% endfor %}
        </select>
      </form>
      {% endif %}

      <form method="get">
        <label class="font-semibold text-slate-800 dark:text-slate-100">Quick Filter:</label>
        <select name="category" onchange="this.form.submit()"
                class="ml-2 p-2 border rounded bg-white dark:bg-slate-700 dark:text-slate-300">
          <option value="">All</option>
          <option value="Marketing">Marketing</option>
          <option value="Sales">Sales</option>
          <option value="Operations">Operations</option>
          <option value="R&D">R&D</option>
        </select>
      </form>
  </div>

  <!-- SUMMARY STATISTICS -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
      <h4 class="text-xl font-semibold mb-4 text-slate-900 dark:text-slate-300">ğŸ“ˆ Summary Statistics</h4>

      <ul class="space-y-2 text-slate-700 dark:text-slate-300">
        <li><strong>Total Revenue:</strong> {{ revenue }}</li>
        <li><strong>Total Expenses:</strong> {{ expenses }}</li>
        <li><strong>Total Profit:</strong> {{ profit }}</li>
        <li><strong>Profit Margin:</strong> {{ margin }}%</li>
        <li><strong>Average Monthly Revenue:</strong> {{ avg_revenue }}</li>
        <li><strong>Average Monthly Expenses:</strong> {{ avg_expenses }}</li>
      </ul>

      {% if chart_html %}
      <hr class="my-4 border-gray-300 dark:border-gray-600">
      <h4 class="text-xl mb-3 text-slate-900 dark:text-slate-300">ğŸ“Š Visual Financial Performance</h4>
      <div>{{ chart_html | safe }}</div>
      {% endif %}
  </div>

  <!-- CHARTS OVERVIEW -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
    <h4 class="text-xl font-semibold mb-3 text-slate-900 dark:text-slate-300">ğŸ“Š Charts Overview</h4>

    <h5 class="font-semibold text-slate-800 dark:text-white">Monthly Comparison</h5>
    {{ bar_chart | safe }}
    <a href="{{ url_for('download_bar_chart') }}" class="mt-2 inline-block px-4 py-2 border border-green-600 text-green-600 rounded">Download</a>

    <hr class="my-4">

    <h5 class="font-semibold text-slate-800 dark:text-white">Profit vs Expenses</h5>
    {{ pie_chart | safe }}
    <a href="{{ url_for('download_pie_chart') }}" class="mt-2 inline-block px-4 py-2 border border-green-600 text-green-600 rounded">Download</a>

    <hr class="my-4">

    <h5 class="font-semibold text-slate-800 dark:text-slate-300">Expenses by Category</h5>
    {{ category_pie_chart | safe }}

    <hr class="my-4">

    <h5 class="font-semibold text-slate-800 dark:text-slate-300">Trend Over Time</h5>
    {{ line_chart | safe }}
    <a href="{{ url_for('download_line_chart') }}" class="mt-2 inline-block px-4 py-2 border border-green-600 text-green-600 rounded">Download</a>
  </div>

  <!-- AI ADVICE -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
    <h4 class="text-xl font-semibold mb-3 text-slate-900 dark:text-slate-300">ğŸ§  AI Advice & Insights</h4>

    <div class="p-4 bg-sky-50 dark:bg-slate-700/60 text-slate-700 dark:text-slate-200 rounded">
      {{ advice | safe }}
    </div>

    {% if charts %}
      <section class="mt-4">
        <h5 class="font-semibold mb-2 text-slate-900 dark:text-slate-300">ğŸ“Š Visual Insights</h5>
        {% for chart in charts %}
          <img class="rounded-lg mb-4" src="{{ chart }}" alt="Financial Chart">
        {% endfor %}
      </section>
    {% endif %}

    <h5 class="font-semibold mt-4 text-slate-900 dark:text-slate-300">ğŸ“Š Trend Insights</h5>
    <ul class="list-disc ml-5 text-slate-700 dark:text-slate-300">
      {% for insight in trend_insights %}
        <li>{{ insight }}</li>
      {% endfor %}
    </ul>

    <form action="{{ url_for('download_advice') }}" method="POST" class="mt-3">
        <input type="hidden" name="advice" value="{{ advice }}">
        <button class="px-3 py-2 border border-green-600 text-green-600 rounded shadow">ğŸ’¾ Download</button>
    </form>
  </div>

  <!-- EMAIL + REPORTS -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
    <h4 class="text-xl font-semibold mb-4 text-slate-900 dark:text-slate-300">ğŸ“§ Send Reports</h4>

    <form action="{{ url_for('send_summary') }}" method="POST" class="grid md:grid-cols-2 gap-4 mb-4">
      <input type="hidden" name="revenue" value="{{ revenue }}">
      <input type="hidden" name="expenses" value="{{ expenses }}">
      <input type="hidden" name="profit" value="{{ profit }}">
      <input type="hidden" name="margin" value="{{ margin }}">
      <input type="hidden" name="advice" value="{{ advice }}">

      <input type="email" name="email" placeholder="Enter email" class="p-2 border rounded dark:bg-gray-700 dark:text-slate-300" required>
      <button class="px-3 py-2 bg-blue-600 text-white rounded">ğŸ“§ Send Summary</button>
    </form>

    <form action="{{ url_for('download_report') }}" method="POST" class="mb-4">
      <input type="hidden" name="revenue" value="{{ revenue }}">
      <input type="hidden" name="expenses" value="{{ expenses }}">
      <input type="hidden" name="profit" value="{{ profit }}">
      <input type="hidden" name="margin" value="{{ margin }}">
      <input type="hidden" name="advice" value="{{ advice }}">
      <button class="px-4 py-2 bg-blue-600 text-white rounded shadow">â¬‡ Download PDF Report</button>
    </form>

    <form action="{{ url_for('send_report') }}" method="POST">
      <input type="hidden" name="revenue" value="{{ revenue }}">
      <input type="hidden" name="expenses" value="{{ expenses }}">
      <input type="hidden" name="profit" value="{{ profit }}">
      <input type="hidden" name="margin" value="{{ margin }}">
      <input type="hidden" name="advice" value="{{ advice }}">
      
      <label class="font-semibold text-slate-900 dark:text-white">Send full report:</label>
      <input type="email" name="email" class="p-2 border rounded w-full dark:bg-gray-700 dark:text-slate-300 mb-2" required>
      <button class="px-4 py-2 bg-blue-600 text-white rounded shadow">ğŸ“© Email Report</button>
    </form>
  </div>

  <!-- RAW DATA TABLE -->
  <div class="bg-white dark:bg-slate-800/60 shadow rounded-lg p-6 mb-6">
    <h4 class="text-xl font-semibold mb-3 text-slate-900 dark:text-slate-300">ğŸ“„ Raw Data</h4>

    <form method="POST" action="{{ url_for('view_file', filename=filename) }}">
      <div class="flex gap-2">
        <input type="text" name="search" placeholder="Search..."
               class="flex-1 p-2 border rounded dark:bg-gray-700 dark:text-white">
        <button class="px-4 py-2 bg-blue-600 text-white rounded shadow">Search</button>
      </div>
    </form>

    <div class="mt-6 overflow-auto text-slate-800 dark:text-slate-200">
      {{ table_html | safe }}
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="text-center text-slate-600 dark:text-slate-400 py-6">
      Â© {{ current_year }} OptiGain. All rights reserved.
  </footer>

</div>

<!-- jQuery + DataTables -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

<script>
  $(document).ready(function () {
    $('table').DataTable();
  });
</script>

<!-- SIDEBAR JS -->
<script>
const sidebar = document.getElementById("sidebar");
const toggle = document.getElementById("sidebarToggle");
const overlay = document.getElementById("mobileSidebarOverlay");

toggle?.addEventListener("click", () => {
    sidebar.classList.toggle("-translate-x-full");
    overlay.classList.toggle("hidden");
});

overlay?.addEventListener("click", () => {
    sidebar.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
});
</script>

<!-- Dark Mode script (matches dashboard) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggle = document.getElementById('darkToggle');
  const root = document.documentElement;

  // Load saved theme
  if (localStorage.getItem('theme') === 'dark') {
    root.classList.add('dark');
    toggle?.setAttribute('aria-pressed', 'true');
  }

  toggle?.addEventListener('click', () => {
    const isDark = root.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggle = document.getElementById("actionToggle");
  const menu = document.getElementById("actionMenu");

  if (!toggle || !menu) return;

  toggle.addEventListener("click", (e) => {
    e.stopPropagation();
    menu.classList.toggle("hidden");
  });

  document.addEventListener("click", (e) => {
    if (!menu.contains(e.target) && !toggle.contains(e.target)) {
      menu.classList.add("hidden");
    }
  });
});
</script>
</body>
</html>